generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  OPERATOR
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  UPI
  CHEQUE
}

enum AuditAction {
  DONATION_CREATED
  DONATION_EMAIL_SENT
  EMAIL_SENT // For receipt emails
  EMAIL_RESENT // For resend operations
  EMAIL_FAILED // For failed email attempts
  WHATSAPP_SENT // NEW: WhatsApp notification sent
  WHATSAPP_FAILED // NEW: WhatsApp notification failed
  OPERATOR_LOGIN
  ADMIN_LOGIN
  PDF_EXPORTED
  EMAIL_CHANGED
  USER_CREATED
  USER_UPDATED
  PASSWORD_CHANGED
  // üîê  FOR PASSWORD RESET
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
}

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  passwordHash        String
  name                String
  phone               String?
  role                Role      @default(OPERATOR)
  isActive            Boolean   @default(true)
  // üîê ADD THESE FOR PASSWORD RESET
  resetPasswordToken  String?   @unique
  resetPasswordExpiry DateTime?
  lastLogin           DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  donations Donation[]
  auditLogs AuditLog[]

  @@map("users")
}

model Donation {
  id            String        @id @default(uuid())
  donorName     String
  donorEmail    String? // Optional email field for donor
  donorPhone    String
  amount        Decimal       @db.Decimal(10, 2)
  purpose       String
  paymentMethod PaymentMethod
  notes         String?
  date          DateTime      @default(now())

  // Email tracking fields
  emailSent     Boolean   @default(false) // Track if receipt email was sent
  emailSentAt   DateTime? // Timestamp when email was sent
  emailError    String? // Store error message if email failed
  receiptNumber String? // Optional custom receipt number

  // WhatsApp tracking fields - NEW
  whatsappSent      Boolean   @default(false) // Track if WhatsApp notification was sent
  whatsappSentAt    DateTime? // Timestamp when WhatsApp was sent
  whatsappMessageId String? // WhatsApp message ID from Meta API
  whatsappError     String? // Store error message if WhatsApp failed

  // Foreign keys
  operatorId String
  categoryId String?

  // Relations
  operator User              @relation(fields: [operatorId], references: [id])
  category DonationCategory? @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([operatorId])
  @@index([categoryId])
  @@index([date])
  @@index([donorEmail])
  @@index([donorPhone])
  @@index([emailSent])
  @@index([whatsappSent]) // NEW: Index for WhatsApp tracking
  @@map("donations")
}

model DonationCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  icon        String?  @default("Tag")
  color       String?  @default("#3b82f6")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  donations Donation[]

  @@map("donation_categories")
}

model AuditLog {
  id          String      @id @default(uuid())
  action      AuditAction
  entityType  String
  entityId    String?
  description String
  userRole    Role
  userId      String
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  timestamp   DateTime    @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([timestamp])
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@map("audit_logs")
}
