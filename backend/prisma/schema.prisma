generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

enum Role {
  ADMIN
  OPERATOR
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  UPI
  CHEQUE
}

enum AuditAction {
  DONATION_CREATED
  DONATION_EMAIL_SENT
  EMAIL_SENT              // For receipt emails
  EMAIL_RESENT            // For resend operations
  EMAIL_FAILED            // For failed email attempts
  WHATSAPP_SENT           //  WhatsApp notification sent
  WHATSAPP_FAILED         // WhatsApp notification failed
  DONATION_UPDATED
  DONATION_DELETED
  DONATION_RESTORED
  WHATSAPP_SKIPPED
  OPERATOR_LOGIN
  ADMIN_LOGIN
  PDF_EXPORTED
  EMAIL_CHANGED
  USER_CREATED
  USER_UPDATED
  PASSWORD_CHANGED
  // üîê  FOR PASSWORD RESET
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  name          String
  phone         String?
  role          Role     @default(OPERATOR)
  isActive      Boolean  @default(true)

  resetPasswordToken   String?   @unique
  resetPasswordExpiry  DateTime?

  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // ‚úÖ EXPLICIT BACK-RELATIONS
  donationsCreated Donation[] @relation("OperatorDonations")
  donationsDeleted Donation[] @relation("DeletedDonations")

  auditLogs     AuditLog[]

  @@map("users")
}


model Donation {
  id              String        @id @default(uuid())
  donorName       String
  donorEmail      String?
  donorPhone      String
  amount          Decimal       @db.Decimal(10, 2)
  purpose         String
  paymentMethod   PaymentMethod
  notes           String?
  date            DateTime      @default(now())

  emailSent       Boolean       @default(false)
  emailSentAt     DateTime?
  emailError      String?
  receiptNumber   String?

  whatsappSent       Boolean       @default(false)
  whatsappSentAt     DateTime?
  whatsappMessageId  String?
  whatsappError      String?

  operatorId      String
  categoryId      String?
  deletedBy       String?

  // ‚úÖ NAMED RELATIONS (CRITICAL)
  operator        User  @relation("OperatorDonations", fields: [operatorId], references: [id])
  deletedByUser   User? @relation("DeletedDonations", fields: [deletedBy], references: [id])

  category        DonationCategory? @relation(fields: [categoryId], references: [id])

  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  deletionReason  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("donations")
  @@index([operatorId])
  @@index([categoryId])
  @@index([deletedBy])
}


model DonationCategory {
  id            String        @id @default(uuid())
  name          String        @unique
  description   String?
  icon          String?       @default("Tag")        
  color         String?       @default("#3b82f6")    
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  donations     Donation[]
  
  @@map("donation_categories")
}

model AuditLog {
  id            String        @id @default(uuid())
  action        AuditAction
  entityType    String
  entityId      String?
  description   String
  userRole      Role
  userId        String
  ipAddress     String?
  userAgent     String?
  metadata      Json?
  timestamp     DateTime      @default(now())
  
  // Relations
  user          User          @relation(fields: [userId], references: [id])
  
  @@map("audit_logs")
  @@index([timestamp])
  @@index([userId])
  @@index([action])
  @@index([entityType])
}